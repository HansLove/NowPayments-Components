# DepositModal Component

A complete 3-step deposit flow with currency selection, amount input, and payment confirmation with QR code.

## Props Interface

```typescript
interface DepositModalProps {
  isOpen: boolean
  onClose: () => void
  customerEmail?: string | (() => Promise<string>)
  showEmailInput?: boolean
  shouldNotifyByEmail?: boolean
  onSubmit: (formData: DepositFormData) => Promise<any>
  onSuccess?: (backendResponse: any) => PaymentDetails | Promise<PaymentDetails>
  onError?: (error: Error) => void
}

interface DepositFormData {
  selectedCurrency: string // e.g., 'btc', 'eth'
  amount: number
  customerEmail?: string
}

interface PaymentDetails {
  address: string
  paymentId: string
}
```

## Basic Usage

```tsx
import { useState } from 'react'
import { DepositModal, type DepositFormData } from '@taloon/nowpayments-components'

function DepositExample() {
  const [isOpen, setIsOpen] = useState(false)

  const handleSubmit = async (formData: DepositFormData) => {
    // Send to your backend API
    const response = await fetch('/api/deposits', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ...formData,
        userId: 'user-123',
        sessionId: 'session-456'
      })
    })

    if (!response.ok) {
      throw new Error('Failed to create deposit')
    }

    return response.json()
  }

  return (
    <>
      <button onClick={() => setIsOpen(true)}>
        Open Deposit Modal
      </button>

      <DepositModal
        isOpen={isOpen}
        onClose={() => setIsOpen(false)}
        onSubmit={handleSubmit}
        onSuccess={(result) => {
          console.log('Deposit created:', result)
          setIsOpen(false)

          // Return PaymentDetails for the component to display
          return {
            address: result.depositAddress,
            paymentId: result.paymentId
          }
        }}
        onError={(error) => {
          console.error('Error:', error.message)
        }}
      />
    </>
  )
}
```

## Email Configuration Options

### Option 1: Provided Customer Email

```tsx
function DepositWithEmail() {
  const [isOpen, setIsOpen] = useState(false)

  // Async email function
  const getCustomerEmail = async () => {
    const user = await getCurrentUser()
    return user.email
  }

  return (
    <DepositModal
      isOpen={isOpen}
      onClose={() => setIsOpen(false)}
      customerEmail={getCustomerEmail} // Email provided - no input shown
      shouldNotifyByEmail={true}
      onSubmit={handleSubmit}
      onSuccess={handleSuccess}
    />
  )
}
```

### Option 2: User Email Input

```tsx
function DepositWithEmailInput() {
  const [isOpen, setIsOpen] = useState(false)

  return (
    <DepositModal
      isOpen={isOpen}
      onClose={() => setIsOpen(false)}
      showEmailInput={true} // Shows email input field
      shouldNotifyByEmail={true}
      onSubmit={handleSubmit}
      onSuccess={handleSuccess}
    />
  )
}
```

### Option 3: Static Email

```tsx
function DepositWithStaticEmail() {
  return (
    <DepositModal
      isOpen={isOpen}
      onClose={() => setIsOpen(false)}
      customerEmail="user@example.com" // Static email - no input shown
      shouldNotifyByEmail={true}
      onSubmit={handleSubmit}
      onSuccess={handleSuccess}
    />
  )
}
```

## Form Data Flow

### 1. User Interaction
- Step 1: User selects cryptocurrency (BTC, ETH, USDT, etc.)
- Step 2: User enters deposit amount
- Step 3: Payment details displayed with QR code

### 2. Form Submission
The component sends a fixed schema to your backend:

```javascript
{
  selectedCurrency: "btc",     // Currency ID from NOWPayments
  amount: 0.001,               // User-entered amount
  customerEmail: "user@example.com" // Optional, if enabled
}
```

### 3. Backend Response & Payment Details Mapping

Your backend can return any structure. The `onSuccess` callback maps it to `PaymentDetails`:

```javascript
// Backend response (any structure)
{
  id: "dep_123",
  paymentData: {
    address: "1A2B3C4D5E...",
    reference: "payment_123"
  },
  amount: 0.001,
  currency: "btc",
  status: "waiting"
}

// onSuccess mapping
onSuccess: (backendResponse) => {
  return {
    address: backendResponse.paymentData.address,
    paymentId: backendResponse.paymentData.reference
  }
}
```

Alternative response structures:

```javascript
// Minimal backend response
{
  depositAddress: "1A2B3C4D5E...",
  paymentId: "payment_123"
}

// Direct mapping
onSuccess: (response) => ({
  address: response.depositAddress,
  paymentId: response.paymentId
})
```

## Payment Confirmation Step

The final step automatically displays:
- QR code with the deposit address
- Payment amount and currency
- Payment ID (truncated for display)
- Copy button for the address
- Warning about sending correct currency
- Email notification message (if configured)
- NOWPayments branding

## Error Handling

```tsx
function DepositWithErrorHandling() {
  const [error, setError] = useState<string | null>(null)

  const handleSubmit = async (formData: DepositFormData) => {
    try {
      const response = await createDeposit(formData)
      return response
    } catch (err) {
      // Handle specific error types
      if (err instanceof NetworkError) {
        throw new Error('Network connection failed. Please try again.')
      }
      throw err
    }
  }

  const handleError = (error: Error) => {
    setError(error.message)
    // Log to your error tracking service
    console.error('Deposit error:', error)
  }

  return (
    <>
      {error && (
        <div className="error-banner">
          {error}
          <button onClick={() => setError(null)}>Ã—</button>
        </div>
      )}

      <DepositModal
        isOpen={isOpen}
        onClose={() => setIsOpen(false)}
        onSubmit={handleSubmit}
        onError={handleError}
        onSuccess={(result) => {
          setError(null)
          return {
            address: result.depositAddress,
            paymentId: result.paymentId
          }
        }}
      />
    </>
  )
}
```

## Styling

The modal uses CSS custom properties for theming:

```css
/* Customize the modal appearance */
.np-modal {
  --np-primary: #your-brand-color;
  --np-surface: #your-background-color;
}

/* Style the payment status indicator */
.nowpayments-payment-status__dot {
  background: var(--np-accent);
  box-shadow: 0 0 10px var(--np-accent);
}
```

## Integration Notes

- **Currency List**: Automatically fetched from NOWPayments API using your configured API key
- **QR Codes**: Generated client-side using the deposit address
- **Address Validation**: Your backend should validate addresses from NOWPayments
- **Webhook Handling**: Your backend should handle NOWPayments IPN callbacks for payment confirmations